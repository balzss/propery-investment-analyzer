<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Investment Analyzer</title>
    <!-- Chart.js for the diagram -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .currency-input-wrapper { position: relative; }
        .currency-symbol { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6b7280; pointer-events: none;}
        .currency-input { padding-left: 50px; }
        .percent-symbol { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #6b7280; pointer-events: none;}
        .suffix-symbol { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #6b7280; pointer-events: none;}
        
        /* Table Input Styles */
        .table-input {
            background: transparent;
            border-bottom: 1px dashed #cbd5e1;
            padding: 2px 0;
            width: 100%;
            transition: all 0.2s;
        }
        .table-input:focus {
            outline: none;
            border-bottom: 1px solid #4f46e5;
            background: #f8fafc;
        }
        /* Prevent table from stretching too far */
        .results-table-container {
            max-width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body class="text-gray-800 bg-gray-50 min-h-screen flex flex-col">

    <!-- Header -->
    <!-- z-30 ensures the shadow casts on top of the sidebar (z-20) -->
    <header class="bg-white shadow-md relative z-30">
        <div class="w-full p-6 flex items-center">
            <h1 class="text-2xl font-bold text-indigo-600">
                Property Investment Analyzer
            </h1>
        </div>
    </header>

    <!-- Main Content -->
    <div class="flex flex-col md:flex-row flex-1 min-w-0">
        
        <!-- Sidebar: Input Form -->
        <div class="w-full md:w-96 min-w-[375px] bg-white border-r border-gray-200 p-6 shadow-lg relative z-20">
            <h2 class="text-lg font-semibold mb-4 text-gray-800">Add New Property</h2>
            
            <form id="propertyForm" class="space-y-4">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Property Name</label>
                    <input type="text" id="pName" class="w-full rounded-md border-gray-300 border p-2 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" placeholder="e.g., Downtown Flat" required>
                </div>

                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Property Price (Millions)</label>
                        <div class="currency-input-wrapper">
                            <input type="number" step="0.1" id="pValue" class="w-full rounded-md border-gray-300 border p-2 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" placeholder="40" required>
                            <span class="suffix-symbol">M Ft</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                     <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Down Payment (%)</label>
                        <div class="currency-input-wrapper">
                            <input type="number" id="pDownPercent" value="20" class="w-full rounded-md border-gray-300 border p-2 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" placeholder="20" required>
                            <span class="percent-symbol">%</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Renovation (Millions)</label>
                        <div class="currency-input-wrapper">
                            <input type="number" step="0.1" id="pReno" value="0" class="w-full rounded-md border-gray-300 border p-2 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" placeholder="0">
                            <span class="suffix-symbol">M Ft</span>
                        </div>
                    </div>
                </div>
                
                <!-- Real-time Initial Cash Display (Hidden by default) -->
                <div id="initialCashInfo" class="bg-indigo-50 rounded-md p-3 border border-indigo-100 hidden">
                    <div id="downPaymentDisplay" class="text-sm text-indigo-800 font-semibold">
                        <!-- Calculated value shows here -->
                    </div>
                    <div class="text-xs text-indigo-500 mt-1">
                        Includes: Down Pmt + Renovation + Tax (4%) + Lawyer (0.5%)
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Interest Rate</label>
                        <div class="currency-input-wrapper">
                            <input type="number" step="0.1" id="pRate" value="6" class="w-full rounded-md border-gray-300 border p-2 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" placeholder="6" required>
                            <span class="percent-symbol">%</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Loan Term</label>
                        <div class="currency-input-wrapper">
                            <input type="number" id="pTerm" value="30" class="w-full rounded-md border-gray-300 border p-2 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" required>
                            <span class="percent-symbol">Yrs</span>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Expected Monthly Rent (Thousands)</label>
                    <div class="currency-input-wrapper">
                        <input type="number" id="pRent" class="w-full rounded-md border-gray-300 border p-2 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" placeholder="200" required>
                        <span class="suffix-symbol">k Ft</span>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Annual Appreciation (Inflation)</label>
                    <div class="currency-input-wrapper">
                        <input type="number" step="0.1" id="pInflation" value="3.5" class="w-full rounded-md border-gray-300 border p-2 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" required>
                        <span class="percent-symbol">%</span>
                    </div>
                </div>

                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors">
                    Add Property
                </button>
            </form>
        </div>

        <!-- Dashboard: Results -->
        <div class="flex-1 p-4 md:p-8 min-w-0">
            
            <div id="empty-state" class="flex flex-col items-center justify-center h-64 text-gray-400">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                </svg>
                <p class="text-lg">No properties added yet.</p>
                <p class="text-sm">Fill out the form to start analyzing.</p>
            </div>

            <!-- Table Section -->
            <div id="results-section" class="bg-white rounded-lg shadow mb-8 hidden overflow-hidden">
                <div class="results-table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-slate-100">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider min-w-[120px]">Property</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider min-w-[100px]">Price (M)</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider min-w-[120px]">Initial Cash</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Mortgage</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider min-w-[90px]">Rent (k)</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">Cashflow</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">ROI 5y</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-slate-600 uppercase tracking-wider">ROI 10y</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-semibold text-slate-600 uppercase tracking-wider">Action</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Rows added via JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Chart Section Container -->
            <div id="charts-container" class="grid grid-cols-1 xl:grid-cols-2 gap-6 hidden pb-8">
                <!-- ROI Chart (Now First) -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Cumulative ROI (%) (15 Years)</h3>
                    <div class="relative h-80 w-full">
                        <canvas id="roiChart"></canvas>
                    </div>
                </div>

                <!-- Value Chart (Now Second) -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Projected Property Value (15 Years)</h3>
                    <div class="relative h-80 w-full">
                        <canvas id="valueChart"></canvas>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Global Tooltip Element -->
    <div id="global-tooltip" class="fixed z-50 hidden bg-gray-800 text-white p-3 rounded-lg shadow-xl text-xs pointer-events-none transform -translate-x-1/2 -translate-y-full w-56">
        <!-- Content injected via JS -->
    </div>

    <!-- Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm px-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md overflow-hidden transform transition-all">
            <div class="p-6">
                <div class="flex items-center gap-3 text-red-600 mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <h3 class="text-xl font-bold">Remove Property</h3>
                </div>
                <p class="text-gray-600 mb-6">
                    Are you sure you want to remove "<span id="delete-property-name" class="font-semibold text-gray-900"></span>"? This action will permanently delete the property from your analyzer.
                </p>
                <div class="flex justify-end gap-3">
                    <button onclick="closeDeleteModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Cancel
                    </button>
                    <button onclick="executeDelete()" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition-colors shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500">
                        Remove Property
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- Application State ---
    let properties = [];
    let valueChartInstance = null;
    let roiChartInstance = null;
    let propertyIdToDelete = null;

    // --- Local Storage Helper ---
    const saveProperties = () => {
        localStorage.setItem('property_analyzer_data', JSON.stringify(properties));
    };

    // --- Formatters ---
    const formatHUF = (num) => {
        return new Intl.NumberFormat('hu-HU', { 
            style: 'currency', 
            currency: 'HUF', 
            maximumFractionDigits: 0 
        }).format(num);
    };

    const formatCompact = (num) => {
        return new Intl.NumberFormat('hu-HU', { 
            notation: "compact", 
            compactDisplay: "short",
            maximumFractionDigits: 2 
        }).format(num);
    }

    // --- Calculations ---
    const calculateMortgage = (principal, annualRate, years) => {
        if (principal <= 0) return 0;
        const monthlyRate = annualRate / 100 / 12;
        const numberOfPayments = years * 12;
        
        if (monthlyRate === 0) return principal / numberOfPayments;
        
        const x = Math.pow(1 + monthlyRate, numberOfPayments);
        const monthlyPayment = principal * ((monthlyRate * x) / (x - 1));
        return monthlyPayment;
    };

    const getRemainingBalance = (principal, annualRate, termYears, year) => {
        const r = annualRate / 100 / 12;
        const n = termYears * 12;
        const p = year * 12;

        if (p >= n) return 0;
        if (r === 0) return principal - (principal/n)*p; 

        // Formula for remaining balance
        const numerator = Math.pow(1 + r, n) - Math.pow(1 + r, p);
        const denominator = Math.pow(1 + r, n) - 1;
        
        return principal * (numerator / denominator);
    };

    const calculateProjectedROI = (prop, targetYear) => {
        if (prop.totalInvested <= 0) return 0;

        let currentPrice = prop.price;
        let accumulatedCashflow = 0;
        const annualMortgage = prop.monthlyPayment * 12;
        const inflationRate = prop.inflation / 100;

        for (let i = 1; i <= targetYear; i++) {
            // Update Price (Assuming price grows at inflation rate)
            currentPrice = currentPrice * (1 + inflationRate);

            // Update Cashflow (Rent grows with inflation)
            const yearlyRent = (prop.rent * 12) * Math.pow(1 + inflationRate, i - 1);
            const yearlyCashflow = yearlyRent - annualMortgage;
            accumulatedCashflow += yearlyCashflow;
        }

        const remainingLoan = getRemainingBalance(prop.loanAmount, prop.rate, prop.term, targetYear);
        const equity = currentPrice - remainingLoan;
        
        // Total Position = Equity + accumulated cashflow
        const totalPosition = equity + accumulatedCashflow;
        
        // Profit = Position - Initial Investment
        const profit = totalPosition - prop.totalInvested;

        return (profit / prop.totalInvested) * 100;
    };

    const recalculateProperty = (prop) => {
        const price = prop.price;
        const rent = prop.rent;
        const downPaymentPercent = prop.downPaymentPercent;
        const renoCost = prop.renoCost;
        const rate = prop.rate;
        const term = prop.term;

        // Fees
        const tax = price * 0.04;
        const lawyer = price * 0.005;
        const downPayment = price * (downPaymentPercent / 100);

        // Total Initial Investment
        const totalInvested = downPayment + renoCost + tax + lawyer;

        const loanAmount = price - downPayment;
        const monthlyPayment = calculateMortgage(loanAmount, rate, term);
        const cashflow = rent - monthlyPayment;

        // Update prop object
        prop.downPayment = downPayment;
        prop.totalInvested = totalInvested;
        prop.loanAmount = loanAmount;
        prop.monthlyPayment = monthlyPayment;
        prop.cashflow = cashflow;
        
        return prop;
    };


    // --- DOM Elements ---
    const form = document.getElementById('propertyForm');
    const tableBody = document.getElementById('resultsTableBody');
    const resultsSection = document.getElementById('results-section');
    const chartsContainer = document.getElementById('charts-container');
    const emptyState = document.getElementById('empty-state');
    const tooltip = document.getElementById('global-tooltip');
    const deleteModal = document.getElementById('delete-modal');
    const deletePropNameEl = document.getElementById('delete-property-name');
    
    // Real-time calculation elements (Sidebar)
    const pValueInput = document.getElementById('pValue');
    const pDownPercentInput = document.getElementById('pDownPercent');
    const pRenoInput = document.getElementById('pReno');
    const downPaymentDisplay = document.getElementById('downPaymentDisplay');
    const initialCashInfo = document.getElementById('initialCashInfo');

    // --- Sidebar Helper ---
    const updateDownPaymentDisplay = () => {
        const priceMillions = parseFloat(pValueInput.value) || 0;
        const percent = parseFloat(pDownPercentInput.value) || 0;
        const renoMillions = parseFloat(pRenoInput.value) || 0;
        
        if (priceMillions > 0) {
            initialCashInfo.classList.remove('hidden');
            const actualPrice = priceMillions * 1000000;
            const renoCost = renoMillions * 1000000;
            const downPaymentValue = actualPrice * (percent / 100);
            const tax = actualPrice * 0.04;
            const lawyer = actualPrice * 0.005;
            const totalCash = downPaymentValue + renoCost + tax + lawyer;
            downPaymentDisplay.textContent = `Total Cash Needed: ${formatHUF(totalCash)}`;
        } else {
            initialCashInfo.classList.add('hidden');
            downPaymentDisplay.textContent = 'Total Cash Needed: 0 Ft';
        }
    };

    pValueInput.addEventListener('input', updateDownPaymentDisplay);
    pDownPercentInput.addEventListener('input', updateDownPaymentDisplay);
    pRenoInput.addEventListener('input', updateDownPaymentDisplay);

    // --- Form Submit ---
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        addProperty();
    });

    // --- Logic ---
    function addProperty() {
        const name = document.getElementById('pName').value;
        const priceMillions = parseFloat(document.getElementById('pValue').value);
        const downPaymentPercent = parseFloat(document.getElementById('pDownPercent').value);
        const renoMillions = parseFloat(document.getElementById('pReno').value) || 0;
        const rate = parseFloat(document.getElementById('pRate').value);
        const term = parseFloat(document.getElementById('pTerm').value);
        const rentThousands = parseFloat(document.getElementById('pRent').value);
        const inflation = parseFloat(document.getElementById('pInflation').value);

        const price = priceMillions * 1000000;
        const rent = rentThousands * 1000;
        const renoCost = renoMillions * 1000000;

        let newProp = {
            id: Date.now(),
            name,
            price,
            rent,
            renoCost,
            downPaymentPercent,
            rate,
            term,
            inflation,
            isEditing: false
        };

        newProp = recalculateProperty(newProp);
        properties.push(newProp);
        saveProperties();
        updateUI();
        
        document.getElementById('pName').value = '';
        document.getElementById('pValue').value = '';
        document.getElementById('pRent').value = '';
        document.getElementById('pReno').value = '0';
        updateDownPaymentDisplay();
    }

    // --- Tooltip Logic ---
    window.showBreakdownTooltip = (e, id) => {
        const prop = properties.find(p => p.id === id);
        if(!prop) return;

        const tax = prop.price * 0.04;
        const lawyer = prop.price * 0.005;

        tooltip.innerHTML = `
            <div class="font-bold mb-2 border-b border-gray-600 pb-1 text-gray-200">Initial Cash Breakdown</div>
            <div class="space-y-1">
                <div class="flex justify-between">
                    <span class="text-gray-400">Down Pmt:</span> 
                    <span>${formatCompact(prop.downPayment)}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Renovation:</span> 
                    <span>${formatCompact(prop.renoCost)}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Tax (4%):</span> 
                    <span>${formatCompact(tax)}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Lawyer (0.5%):</span> 
                    <span>${formatCompact(lawyer)}</span>
                </div>
                <div class="mt-2 pt-1 border-t border-gray-600 flex justify-between font-bold text-indigo-300">
                    <span>Total:</span> 
                    <span>${formatCompact(prop.totalInvested)}</span>
                </div>
            </div>
            <div class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-gray-800"></div>
        `;
        
        const rect = e.currentTarget.getBoundingClientRect();
        tooltip.style.left = `${rect.left + rect.width / 2}px`;
        tooltip.style.top = `${rect.top - 8}px`; 
        tooltip.classList.remove('hidden');
    }

    window.hideBreakdownTooltip = () => {
        tooltip.classList.add('hidden');
    }

    window.toggleEdit = (id) => {
        const prop = properties.find(p => p.id === id);
        if (!prop) return;

        // If we are currently editing (meaning we clicked Save)
        if (prop.isEditing) {
            // Gather values from inputs
            const nameInput = document.getElementById(`input-name-${id}`);
            const priceInput = document.getElementById(`input-price-${id}`);
            const downInput = document.getElementById(`input-down-${id}`);
            const renoInput = document.getElementById(`input-reno-${id}`);
            const rentInput = document.getElementById(`input-rent-${id}`);

            if (nameInput) prop.name = nameInput.value;
            if (priceInput) prop.price = (parseFloat(priceInput.value) || 0) * 1000000;
            if (downInput) prop.downPaymentPercent = parseFloat(downInput.value) || 0;
            if (renoInput) prop.renoCost = (parseFloat(renoInput.value) || 0) * 1000000;
            if (rentInput) prop.rent = (parseFloat(rentInput.value) || 0) * 1000;

            // Recalculate and Save
            recalculateProperty(prop);
            saveProperties();
            
            // Apply toggle and perform a full refresh (including charts)
            prop.isEditing = false;
            updateUI(); 
        } else {
            // Enter edit mode
            prop.isEditing = true;
            // Only re-render the table, skipping chart destruction/re-creation
            renderTable();
        }
    };

    // --- Delete Property Workflow ---
    window.removeProperty = (id) => {
        const prop = properties.find(p => p.id === id);
        if (!prop) return;
        
        propertyIdToDelete = id;
        deletePropNameEl.textContent = prop.name;
        deleteModal.classList.remove('hidden');
    };

    window.closeDeleteModal = () => {
        deleteModal.classList.add('hidden');
        propertyIdToDelete = null;
    };

    window.executeDelete = () => {
        if (propertyIdToDelete === null) return;
        
        properties = properties.filter(p => p.id !== propertyIdToDelete);
        saveProperties();
        updateUI();
        closeDeleteModal();
    };

    function initApp() {
        const storedData = localStorage.getItem('property_analyzer_data');
        if (storedData) {
            try {
                properties = JSON.parse(storedData);
                properties.forEach(p => p.isEditing = false);
            } catch (e) {
                console.error("Error parsing local storage", e);
                properties = [];
            }
        } else {
            // No saved data and no hardcoded testing properties
            properties = [];
        }

        updateUI();
    }

    function updateUI() {
        if (properties.length === 0) {
            emptyState.classList.remove('hidden');
            resultsSection.classList.add('hidden');
            chartsContainer.classList.add('hidden');
            return;
        }

        emptyState.classList.add('hidden');
        resultsSection.classList.remove('hidden');
        chartsContainer.classList.remove('hidden');

        renderTable();
        renderCharts();
    }

    function renderTable() {
        tableBody.innerHTML = '';
        properties.forEach(prop => {
            const tr = document.createElement('tr');
            const cfClass = prop.cashflow >= 0 ? 'text-green-600 font-bold' : 'text-red-600 font-bold';
            
            const priceM = (prop.price / 1000000).toFixed(1).replace(/\.0$/, '');
            const rentK = prop.rent / 1000; 
            const renoM = (prop.renoCost / 1000000).toFixed(1).replace(/\.0$/, '');

            const roi5 = calculateProjectedROI(prop, 5);
            const roi10 = calculateProjectedROI(prop, 10);
            
            const roi5Class = roi5 >= 0 ? 'text-green-600' : 'text-red-600';
            const roi10Class = roi10 >= 0 ? 'text-green-600' : 'text-red-600';

            const commonCells = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <div class="cursor-help border-b border-dotted border-gray-400 inline-block pb-0.5"
                         onmouseenter="showBreakdownTooltip(event, ${prop.id})"
                         onmouseleave="hideBreakdownTooltip()"
                         onclick="showBreakdownTooltip(event, ${prop.id})">
                        <div id="ic-text-${prop.id}" class="font-medium text-gray-900">${formatCompact(prop.totalInvested)}</div>
                        <div class="text-xs text-gray-400 mt-0.5">(${prop.downPaymentPercent}% + Fees)</div>
                    </div>
                    ${prop.isEditing ? `
                        <div class="mt-2 space-y-1 border-t pt-1 border-gray-200">
                            <div class="text-xs text-gray-400 flex items-center">
                                <input type="number" id="input-down-${prop.id}" class="table-input w-10 text-xs text-gray-500" 
                                       value="${prop.downPaymentPercent}">
                                <span class="ml-1">% Down</span>
                            </div>
                            <div class="text-xs text-gray-400 flex items-center">
                                <input type="number" step="0.1" id="input-reno-${prop.id}" class="table-input w-10 text-xs text-gray-500" 
                                       value="${renoM}">
                                <span class="ml-1">M Reno</span>
                            </div>
                        </div>
                    ` : ''}
                </td>
            `;

            if (prop.isEditing) {
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        <input type="text" id="input-name-${prop.id}" class="table-input font-bold text-gray-900" 
                               value="${prop.name}">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="flex items-center">
                            <input type="number" step="0.1" id="input-price-${prop.id}" class="table-input w-16" 
                                   value="${priceM}">
                            <span class="ml-1 text-xs">M</span>
                        </div>
                    </td>
                    ${commonCells}
                    <td id="mortgage-${prop.id}" class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatHUF(prop.monthlyPayment)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="flex items-center">
                            <input type="number" id="input-rent-${prop.id}" class="table-input w-16" 
                                   value="${rentK}">
                            <span class="ml-1 text-xs">k</span>
                        </div>
                    </td>
                    <td id="cashflow-${prop.id}" class="px-6 py-4 whitespace-nowrap text-sm ${cfClass}">${formatHUF(prop.cashflow)}</td>
                    <td id="roi5-${prop.id}" class="px-6 py-4 whitespace-nowrap text-sm font-medium ${roi5Class}">${roi5.toFixed(1)}%</td>
                    <td id="roi10-${prop.id}" class="px-6 py-4 whitespace-nowrap text-sm font-medium ${roi10Class}">${roi10.toFixed(1)}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                        <button onclick="toggleEdit(${prop.id})" class="text-indigo-600 hover:text-indigo-900 font-bold">Save</button>
                    </td>
                `;
            } else {
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${prop.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCompact(prop.price)}</td>
                    ${commonCells}
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatHUF(prop.monthlyPayment)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatHUF(prop.rent)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${cfClass}">${formatHUF(prop.cashflow)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${roi5Class}">${roi5.toFixed(1)}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${roi10Class}">${roi10.toFixed(1)}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                        <button onclick="toggleEdit(${prop.id})" class="text-indigo-600 hover:text-indigo-900 hover:underline">Edit</button>
                        <button onclick="removeProperty(${prop.id})" class="text-red-600 hover:text-red-900 hover:underline">Remove</button>
                    </td>
                `;
            }
            
            tableBody.appendChild(tr);
        });
    }

    const chartColors = [
        { border: '#4F46E5', bg: 'rgba(79, 70, 229, 0.1)' }, 
        { border: '#059669', bg: 'rgba(5, 150, 105, 0.1)' }, 
        { border: '#DC2626', bg: 'rgba(220, 38, 38, 0.1)' }, 
        { border: '#D97706', bg: 'rgba(217, 119, 6, 0.1)' }, 
        { border: '#7C3AED', bg: 'rgba(124, 58, 237, 0.1)' }  
    ];

    function renderCharts() {
        const years = 15;
        const labels = Array.from({length: years + 1}, (_, i) => `Year ${i}`);

        const valueDatasets = properties.map((prop, index) => {
            const data = [];
            let currentValue = prop.price;
            for (let i = 0; i <= years; i++) {
                data.push(currentValue);
                currentValue = currentValue * (1 + (prop.inflation / 100));
            }
            const style = chartColors[index % chartColors.length];
            return {
                label: prop.name,
                data: data,
                borderColor: style.border,
                backgroundColor: style.bg,
                borderWidth: 2,
                pointRadius: 2,
                pointHoverRadius: 6,
                fill: false,
                tension: 0.4 
            };
        });

        const roiDatasets = properties.map((prop, index) => {
            const data = [];
            let currentPrice = prop.price;
            let accumulatedCashflow = 0;
            const annualMortgage = prop.monthlyPayment * 12;

            for (let i = 0; i <= years; i++) {
                if (i > 0) {
                     currentPrice = currentPrice * (1 + (prop.inflation / 100));
                }
                const remainingLoan = getRemainingBalance(prop.loanAmount, prop.rate, prop.term, i);
                const equity = currentPrice - remainingLoan;
                if (i > 0) {
                    const yearlyRent = (prop.rent * 12) * Math.pow(1 + (prop.inflation/100), i - 1);
                    const yearlyCashflow = yearlyRent - annualMortgage;
                    accumulatedCashflow += yearlyCashflow;
                }
                const totalPosition = equity + accumulatedCashflow;
                const profit = totalPosition - prop.totalInvested;
                let roi = prop.totalInvested > 0 ? (profit / prop.totalInvested) * 100 : 0;
                data.push(roi);
            }
            const style = chartColors[index % chartColors.length];
            return {
                label: prop.name,
                data: data,
                borderColor: style.border,
                backgroundColor: style.bg,
                borderWidth: 2,
                pointRadius: 2,
                pointHoverRadius: 6,
                fill: false,
                tension: 0.4 
            };
        });

        const bondData = [];
        for (let i = 0; i <= years; i++) {
            const bondRoi = (Math.pow(1.07, i) - 1) * 100;
            bondData.push(bondRoi);
        }
        roiDatasets.push({
            label: 'Állampapír (7%)',
            data: bondData,
            borderColor: '#4b5563', 
            borderDash: [5, 5], 
            borderWidth: 2,
            pointRadius: 0,
            pointHoverRadius: 4,
            fill: false,
            tension: 0.4,
            order: 99 
        });

        const ctxValue = document.getElementById('valueChart').getContext('2d');
        if (valueChartInstance) valueChartInstance.destroy();
        valueChartInstance = new Chart(ctxValue, {
            type: 'line',
            data: { labels: labels, datasets: valueDatasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('hu-HU', { style: 'currency', currency: 'HUF', maximumFractionDigits: 0 }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    },
                    legend: { position: 'top' }
                },
                scales: {
                    x: { grid: { display: false } },
                    y: {
                        ticks: {
                            callback: function(value) {
                                return new Intl.NumberFormat('hu-HU', { notation: "compact", compactDisplay: "short" }).format(value) + ' Ft';
                            }
                        },
                        grid: { color: '#f3f4f6' }
                    }
                }
            }
        });

        const ctxRoi = document.getElementById('roiChart').getContext('2d');
        if (roiChartInstance) roiChartInstance.destroy();
        roiChartInstance = new Chart(ctxRoi, {
            type: 'line',
            data: { labels: labels, datasets: roiDatasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(1) + '%';
                                }
                                return label;
                            }
                        }
                    },
                    legend: { position: 'top' }
                },
                scales: {
                    x: { grid: { display: false } },
                    y: {
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        },
                        grid: { color: '#f3f4f6' }
                    }
                }
            }
        });
    }

    initApp();
</script>
</body>
</html>
